<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>استقبال الطلبات</title>
<style>
body { font-family: Arial, sans-serif; background-color: #121212; color: #e0e0e0; margin:0; padding:0; }
.container { max-width: 900px; margin: 30px auto; background-color: #1e1e1e; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px #000; }
h2 { text-align:center; margin-bottom:20px; }
button { padding:10px 15px; border:none; border-radius:5px; cursor:pointer; font-weight:bold; margin-top:5px; }
.order-card { background-color:#2c2c2c; margin-bottom:10px; padding:10px; border-radius:5px; display:flex; justify-content:space-between; align-items:center; }
.order-info { flex:1; }
.hidden { display:none; }
.small-btn { padding:5px 8px; font-size:12px; margin-left:5px; border-radius:5px; }
.delete-btn { background-color:#ff4d4d; color:#fff; }
.location-btn { background-color:#128c7e; color:#fff; }
.top-buttons { display:flex; justify-content:space-between; margin-bottom:10px; }
</style>
</head>
<body>

<div class="container">
<h2>استقبال الطلبات</h2>

<div id="ordersDiv">
    <div class="top-buttons">
        <button id="backToLoginBtn" style="background-color:#128c7e;">رجوع لتسجيل الدخول</button>
        <button id="refreshBtn" style="background-color:#ffa500;">تحديث الطلبات</button>
        <button id="deleteAllBtn" style="background-color:#ff4d4d;">حذف كل الطلبات</button>
    </div>
    <h3>الطلبات الخاصة بالمكان (<span id="placeTitle">تحميل...</span>)</h3>
    <div id="ordersContainer"><p>جاري تحميل الطلبات...</p></div>
</div>

<!-- صوت الاشعار -->
<audio id="notifSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDpVqFWJfB4rA2-NA4QIl1w07e2LFQaYic",
  authDomain: "tourguideapp-313c1.firebaseapp.com",
  databaseURL: "https://tourguideapp-313c1-default-rtdb.firebaseio.com",
  projectId: "tourguideapp-313c1",
  storageBucket: "tourguideapp-313c1.appspot.com",
  messagingSenderId: "1036127588385",
  appId: "1:1036127588385:web:d144dba8f70fe094395360"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const ordersDiv = document.getElementById('ordersDiv');
const deleteAllBtn = document.getElementById('deleteAllBtn');
const refreshBtn = document.getElementById('refreshBtn');
const ordersContainer = document.getElementById('ordersContainer');
const placeTitle = document.getElementById('placeTitle');
const notifSound = document.getElementById('notifSound');

let currentPlaceCode = null;
let lastOrdersCount = 0;

// طلب إذن الإشعارات
if ("Notification" in window && Notification.permission !== "granted") {
    Notification.requestPermission();
}

async function displayOrders(){
    if(!currentPlaceCode) return;

    const ordersRef = ref(db,'bookings/'+currentPlaceCode);
    const snapshot = await get(ordersRef);
    const ordersObj = snapshot.exists() ? snapshot.val() : {};
    const ordersKeys = Object.keys(ordersObj);

    // تشغيل الصوت والإشعار للطلبات الجديدة
    if(ordersKeys.length > lastOrdersCount){
        notifSound.play();
        if ("Notification" in window && Notification.permission === "granted") {
            const latestOrder = ordersObj[ordersKeys[ordersKeys.length-1]];
            new Notification("طلب جديد", {
                body: `وصل طلب جديد من ${latestOrder.name}`,
                icon: 'https://cdn-icons-png.flaticon.com/512/3081/3081932.png'
            });
        }
    }
    lastOrdersCount = ordersKeys.length;

    ordersContainer.innerHTML='';
    if(ordersKeys.length===0){
        ordersContainer.innerHTML='<p style="text-align:center; color:#ffa500;">لا توجد طلبات جديدة بعد.</p>';
        return;
    }

    ordersKeys.forEach((key,i)=>{
        const order = ordersObj[key];
        const div = document.createElement('div');
        div.className='order-card';
        let info = `<div class="order-info">
                        <strong>الطلب رقم ${i+1}</strong><br>
                        الاسم: ${order.name}<br>
                        رقم الهاتف: ${order.phone}<br>
                        الطلب: ${order.request || ''}<br>
                        الوقت: ${order.time || ''}</div>`;
        let actions = `<div>
                        ${order.location? `<button onclick="openLocation(${order.location.lat},${order.location.lng})" class="small-btn location-btn">فتح موقعي</button>`:''}
                        <button onclick="deleteOrder('${key}')" class="small-btn delete-btn">حذف الطلب</button>
                        </div>`;
        div.innerHTML = info + actions;
        ordersContainer.appendChild(div);
    });
}

async function saveOrders(orders){
    if(!currentPlaceCode) return;
    await set(ref(db,'bookings/'+currentPlaceCode), orders);
}

refreshBtn.addEventListener('click', displayOrders);

deleteAllBtn.addEventListener('click', async ()=>{
    if(!currentPlaceCode) return;
    if(confirm('هل تريد حذف جميع الطلبات؟')){
        await set(ref(db,'bookings/'+currentPlaceCode), {});
        lastOrdersCount = 0;
        displayOrders();
    }
});

document.getElementById('backToLoginBtn').addEventListener('click', () => {
    window.location.href = 'login_page.html';
});

window.deleteOrder = async function(key){
    if(!currentPlaceCode) return;
    if(confirm('هل تريد حذف هذا الطلب؟')){
        await set(ref(db,'bookings/'+currentPlaceCode+'/'+key), null);
        lastOrdersCount -= 1;
        displayOrders();
    }
}

window.openLocation = function(lat,lng){
    window.open(`http://maps.google.com/?q=${lat},${lng}`,'_blank');
}

// تحميل أولي عند فتح الصفحة + تحديث كل 5 ثواني
document.addEventListener('DOMContentLoaded', async () => {
    const urlParams = new URLSearchParams(window.location.search);
    const codeFromURL = urlParams.get('code');
    if(!codeFromURL){
        ordersDiv.innerHTML='<p style="color:red; text-align:center;">لا يوجد رمز المكان في الرابط.</p>';
        return;
    }
    currentPlaceCode = codeFromURL;
    placeTitle.textContent = currentPlaceCode;
    await displayOrders();
    setInterval(displayOrders, 5000);
});
</script>
</div>
</body>
</html>
