<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</title>
<style>
:root {
    --dark-bg: #121212;
    --card-bg: #1f1f1f;
    --gold: #ffc107;
    --blue-royal: #4a6fa5;
    --white: #e0e0e0;
    --border-color: #333333;
    --red-emergency: #cf6679;
    --green-success: #4caf50;
    --yellow-warning: #ffeb3b;
    --text-color: #e0e0e0;
}
body {background-color: var(--dark-bg); color: var(--text-color); font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; direction:rtl;}
.header-controls {display:flex; justify-content:flex-end; padding:15px; background-color:#1f1f1f; border-bottom:1px solid var(--border-color);}
.btn-back {background-color:var(--blue-royal); color:#fff; padding:8px 15px; border-radius:6px; text-decoration:none; font-size:0.9em; transition:background-color 0.3s; border:none; cursor:pointer; margin-left:10px;}
.profile-form-container {max-width: 600px; margin: 40px auto; padding: 30px; background-color: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); border:1px solid var(--gold);}
.profile-img-container {display:flex; justify-content:center; margin-bottom:20px;}
.profile-img-preview {width:120px;height:120px;border-radius:50%;object-fit:cover;border:3px solid var(--blue-royal);background-color:#333;}
input,textarea,select{width:100%; padding:12px; border:1px solid var(--blue-royal); border-radius:6px; background-color:#2a2a2a; color:var(--white); font-size:1em; transition:border-color 0.3s,box-shadow 0.3s;}
input:focus,textarea:focus,select:focus{border-color:var(--gold); box-shadow:0 0 8px rgba(255,193,7,0.5); outline:none;}
button{cursor:pointer;}
.btn-login{margin-top:15px; padding:8px 12px; background-color:var(--blue-royal); color:#fff; border:none; border-radius:6px;}
.btn-login:hover{background-color:#3b5b82;}
.btn-submit{margin-top:30px; width:100%; padding:10px; background-color: var(--gold); border:none; border-radius:6px; color:var(--dark-bg); font-weight:bold;}
.btn-submit:hover{background-color:#e0a800;}
#statusBox{padding:15px; margin-top:20px; text-align:center; font-weight:bold; border-radius:6px; display:none;}
</style>
</head>
<body>
<div class="header-controls">
    <a href="index.html" class="btn-back">ğŸ”™ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
</div>

<div class="profile-form-container">
    <h1 id="pageTitle">Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</h1>
    <p id="roleInfo" style="color: var(--blue-royal); font-weight: bold;"></p>
    
    <div id="statusBox"></div>
    
    <form id="completionForm">
        <div class="profile-img-container">
            <img id="imagePreview" class="profile-img-preview" src="images/guide_man.png" alt="ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ©">
        </div>
        <div class="form-group">
            <label for="profilePicture">ğŸ‘¤ ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ©:</label>
            <input type="file" id="profilePicture" accept="image/*" required>
        </div>
        <div class="form-group">
            <label for="fullName">Ø§Ù„Ø§Ø³Ù… (ÙŠÙ…Ù„Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹):</label>
            <input type="text" id="fullName" readonly style="background-color:#333;" required>
        </div>
        <div class="form-group">
            <label for="age">Ø§Ù„Ø¹Ù…Ø±:</label>
            <input type="number" id="age" required>
        </div>
        <div class="form-group">
            <label for="experience">Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø®Ø¨Ø±Ø©:</label>
            <input type="number" id="experience" required>
        </div>
        <div id="roleSpecificFields"></div>
        <div class="form-group">
            <label for="about">Ù†Ø¨Ø°Ø© Ù…Ø®ØªØµØ±Ø© Ø¹Ù†Ùƒ (Ø³ØªØ¸Ù‡Ø± Ù„Ù„Ø³Ø§Ø¦Ø­):</label>
            <textarea id="about" rows="4" required></textarea>
        </div>
        <button type="submit" class="btn-submit">âœ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </form>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDpVqFWJfB4rA2-NA4QIl1w07e2LFQaYic",
  authDomain: "tourguideapp-313c1.firebaseapp.com",
  databaseURL: "https://tourguideapp-313c1-default-rtdb.firebaseio.com",
  projectId: "tourguideapp-313c1",
  storageBucket: "tourguideapp-313c1.appspot.com",
  messagingSenderId: "1036127588385",
  appId: "1:1036127588385:web:d144dba8f70fe094395360"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const ROLES = {
    GUIDE: {key:"GUIDE", name:"Ù…Ø±Ø´Ø¯ Ø³ÙŠØ§Ø­ÙŠ"},
    COMPANION: {key:"COMPANION", name:"Ù…Ø±Ø§ÙÙ‚ Ù„Ø°ÙˆÙŠ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª Ø§Ù„Ø®Ø§ØµØ©"},
    DRIVER: {key:"DRIVER", name:"Ø³Ø§Ø¦Ù‚ Ù†Ù‚Ù„ Ø®Ø§Øµ"}
};

const urlParams = new URLSearchParams(window.location.search);
const roleKey = urlParams.get('role');
const appId = urlParams.get('appId'); // Ø³ÙŠÙƒÙˆÙ† Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„chat ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
let currentApp = null;

document.addEventListener('DOMContentLoaded', async () => {
    if(!roleKey || !appId){
        const statusBox = document.getElementById('statusBox');
        statusBox.style.display='block';
        statusBox.style.backgroundColor='var(--red-emergency)';
        statusBox.textContent='âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¯ÙˆØ± Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨.';
        document.getElementById('completionForm').style.display='none';
        return;
    }

    try{
        const snapshot = await get(ref(db, 'jobApplications'));
        if(snapshot.exists()){
            const apps = snapshot.val();
            currentApp = Object.values(apps).find(app => app.id === appId);
            if(!currentApp) throw new Error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….');
            document.getElementById('fullName').value = currentApp.fullName || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            document.getElementById('pageTitle').textContent = `Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª: ${ROLES[roleKey].name}`;
            document.getElementById('roleInfo').textContent = `Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${appId}`;
            renderRoleFields(roleKey);
        } else throw new Error('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….');
    }catch(err){
        const statusBox = document.getElementById('statusBox');
        statusBox.style.display='block';
        statusBox.style.backgroundColor='var(--red-emergency)';
        statusBox.textContent = err.message;
        document.getElementById('completionForm').style.display='none';
    }
});

function previewImage(file){
    return new Promise((resolve)=>{
        const reader = new FileReader();
        reader.onload=function(){ 
            document.getElementById('imagePreview').src=reader.result;
            resolve(reader.result);
        }
        reader.readAsDataURL(file);
    });
}

document.getElementById('profilePicture').addEventListener('change', async (e)=>{
    await previewImage(e.target.files[0]);
});

function renderRoleFields(roleKey){
    const container=document.getElementById('roleSpecificFields');
    let fieldsHTML='';
    switch(roleKey){
        case ROLES.GUIDE.key:
            fieldsHTML=`<div class="form-group"><label for="guideType">Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯:</label>
            <select id="guideType" required>
            <option value="">-- Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ --</option>
            <option value="Ø«Ù‚Ø§ÙÙŠ">Ø«Ù‚Ø§ÙÙŠ</option>
            <option value="ØªØ±ÙÙŠÙ‡ÙŠ">ØªØ±ÙÙŠÙ‡ÙŠ</option>
            <option value="Ø¯ÙŠÙ†ÙŠ">Ø¯ÙŠÙ†ÙŠ</option>
            <option value="ØªØ¬Ø§Ø±ÙŠ">ØªØ¬Ø§Ø±ÙŠ</option>
            <option value="Ø§Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
            </select></div>
            <div class="form-group"><label for="groupLimit">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£Ù‚ØµÙ‰:</label>
            <input type="number" id="groupLimit"></div>
            <div class="form-group"><label for="price">Ø³Ø¹Ø± Ø§Ù„ÙŠÙˆÙ…:</label>
            <input type="number" id="price"></div>`;
            break;
        case ROLES.COMPANION.key:
            fieldsHTML=`<div class="form-group"><label for="specialization">Ø§Ù„ØªØ®ØµØµ:</label>
            <select id="specialization" required>
            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØªØ®ØµØµ --</option>
            <option value="Ø³Ù…Ø¹ÙŠ">Ø³Ù…Ø¹ÙŠ</option>
            <option value="Ø¨ØµØ±ÙŠ">Ø¨ØµØ±ÙŠ</option>
            <option value="Ø­Ø±ÙƒÙŠ">Ø­Ø±ÙƒÙŠ</option>
            <option value="ÙƒØ¨Ø§Ø± Ø³Ù†">ÙƒØ¨Ø§Ø± Ø³Ù†</option>
            <option value="Ù…ØªØ¹Ø¯Ø¯">Ù…ØªØ¹Ø¯Ø¯</option>
            </select></div>
            <div class="form-group"><label for="priceDay">Ø³Ø¹Ø± Ø§Ù„ÙŠÙˆÙ…:</label>
            <input type="number" id="priceDay"></div>
            <div class="form-group"><label for="priceHour">Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¹Ø©:</label>
            <input type="number" id="priceHour"></div>`;
            break;
        case ROLES.DRIVER.key:
            fieldsHTML=`<div class="form-group"><label for="cityPrice">Ø£Ø¬Ø±Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</label>
            <input type="number" id="cityPrice"></div>
            <div class="form-group"><label for="outCityPrice">Ø£Ø¬Ø±Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</label>
            <input type="number" id="outCityPrice"></div>`;
            break;
    }
    container.innerHTML=fieldsHTML;
}

document.getElementById('completionForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const submitButton = e.target.querySelector('button[type="submit"]');
    submitButton.disabled=true;

    const statusBox = document.getElementById('statusBox');
    statusBox.style.display='block';
    statusBox.style.backgroundColor='var(--blue-royal)';
    statusBox.textContent='â³ Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';

    const fileInput = document.getElementById('profilePicture');
    const imgDataURL = await previewImage(fileInput.files[0]);

    let assistantData={
        appId: appId,
        name: document.getElementById('fullName').value.trim(),
        age: parseInt(document.getElementById('age').value),
        experience: parseInt(document.getElementById('experience').value),
        about: document.getElementById('about').value.trim(),
        img: imgDataURL
    };

    switch(roleKey){
        case ROLES.GUIDE.key:
            assistantData.guideType=document.getElementById('guideType').value;
            assistantData.groupLimit=parseInt(document.getElementById('groupLimit').value)||0;
            assistantData.price=parseInt(document.getElementById('price').value)||0;
            break;
        case ROLES.COMPANION.key:
            assistantData.specialization=document.getElementById('specialization').value;
            assistantData.priceDay=parseInt(document.getElementById('priceDay').value)||0;
            assistantData.priceHour=parseInt(document.getElementById('priceHour').value)||0;
            break;
        case ROLES.DRIVER.key:
            assistantData.cityPrice=parseInt(document.getElementById('cityPrice').value)||0;
            assistantData.outCityPrice=parseInt(document.getElementById('outCityPrice').value)||0;
            break;
    }

    // Ø­ÙØ¸ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… appId ÙƒÙ…ÙØªØ§Ø­
    const pathMap = {
        [ROLES.GUIDE.key]: 'assistants_guides',
        [ROLES.COMPANION.key]: 'assistants_companions',
        [ROLES.DRIVER.key]: 'assistants_drivers'
    };
    const dbPath = pathMap[roleKey];

    try{
        await set(ref(db, `${dbPath}/${appId}`), assistantData);

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
        const appsSnapshot = await get(ref(db,'jobApplications'));
        if(appsSnapshot.exists()){
            const appsData = appsSnapshot.val();
            const appKey = Object.keys(appsData).find(k => appsData[k].id===appId);
            if(appKey) await update(ref(db,'jobApplications/'+appKey), {status:'ØªÙ… Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„'});
        }

        statusBox.style.backgroundColor='var(--green-success)';
        statusBox.innerHTML=`âœ… ØªÙ… Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.<br>âš ï¸ Ø§Ø­ØªÙØ¸ Ø¨Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø´Ø§Øª ${appKey}.<br><button class="btn-login" onclick="goToAssistantLogin()">Ø§Ø°Ù‡Ø¨ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø³Ø§Ø¹Ø¯</button>`;
    }catch(err){
        statusBox.style.backgroundColor='var(--red-emergency)';
        statusBox.textContent='âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.';
        console.error(err);
    }

    submitButton.disabled=false;
});

function goToAssistantLogin(){
    window.location.href='assistant_login.html';
}
</script>
</body>
    </html>
