<!DOCTYPE html>  
<html lang="ar" dir="rtl">  
<head>  
<meta charset="UTF-8">  
<meta name="viewport" content="width=device-width, initial-scale=1.0">  
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ÙŠÙ† Ø§Ù„Ø³ÙŠØ§Ø­ÙŠÙŠÙ†</title>  
<style>
:root {
    --dark-bg: #121212;
    --card-bg: #1f1f1f;
    --gold: #ffc107;
    --blue-royal: #4a6fa5;
    --white: #e0e0e0;
    --border-color: #333333;
    --red-emergency: #cf6679;
    --green-success: #4caf50;
    --yellow-warning: #ffeb3b;
    --text-color: #e0e0e0;
}
body {background-color: var(--dark-bg); color: var(--text-color); font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0;}
.header-controls {display:flex; justify-content:flex-end; padding:15px; background-color:#1f1f1f; border-bottom:1px solid var(--border-color);}
.btn-back {background-color:var(--blue-royal); color:#fff; padding:8px 15px; border-radius:6px; text-decoration:none; font-size:0.9em; transition:background-color 0.3s; border:none; cursor:pointer; margin-left:10px;}
.btn-back:hover {background-color:#3b5b82;}
.container{ max-width:1000px; margin:20px auto; }
.role-select{ margin-bottom:20px; padding:10px; border-radius:6px; border:1px solid var(--blue-royal); background-color:#2a2a2a; color:#fff; }
.filter-input { width: 100%; padding: 12px; margin-bottom: 20px; border-radius: 6px; border: 1px solid var(--blue-royal); background-color: #2a2a2a; color: var(--white); font-size: 1em; }
.cards-grid{ display:grid; grid-template-columns: repeat(auto-fill,minmax(300px,1fr)); gap:25px; }
.assistant-card{ background-color:#2a2a2a; border-radius:10px; padding:20px; box-shadow:0 4px 15px rgba(0,0,0,0.4); border:1px solid var(--blue-royal); position:relative; transition:transform 0.3s,border-color 0.3s; }
.assistant-card:hover{ transform:translateY(-5px); border-color:var(--gold); }
.card-header{ display:flex; align-items:center; margin-bottom:15px; border-bottom:1px dashed #444; padding-bottom:10px; }
.profile-img{ width:70px; height:70px; border-radius:50%; object-fit:cover; border:2px solid var(--gold); margin-left:15px; }
.card-header h3{ color:var(--gold); margin:0; font-size:1.4em; }
.card-details p{ margin:8px 0; text-align:right; font-size:0.95em; color:#ccc; }
.card-details strong{ color:var(--white); }
.rating{ color: var(--yellow-warning); font-size:1.1em; margin-top:5px; }
.btn-delete{ margin-top:10px; padding:10px 16px; border:none; border-radius:6px; background-color:var(--red-emergency); color:#fff; cursor:pointer; font-size:1.1em; width:48%; display:inline-block; }
.btn-comments { background-color:var(--green-success); margin-left:4%; } /* ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ· Ù„Ù„ØªÙ†Ø³ÙŠÙ‚ */
#commentsModal{ display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); justify-content:center; align-items:center; }
#commentsModal .modal-content{ background-color:#2a2a2a; padding:20px; border-radius:10px; max-width:500px; width:90%; max-height:70%; overflow-y:auto; }
.comment-item{ margin-bottom:10px; border-bottom:1px dashed #555; padding-bottom:5px; display:flex; justify-content:space-between; align-items:center; }
.comment-info { flex-grow: 1; margin-right: 10px; }
.comment-name{ font-weight:bold; color:var(--gold); display:block; }
.comment-stars{ color:var(--yellow-warning); display:block; margin:2px 0; }
.comment-text{ display:block; color:#ccc; margin-top:2px; }
.close-modal{ float:right; cursor:pointer; font-size:1.2em; color:#fff; }
</style>
</head>  

<body>  
<div class="header-controls">  
    <a href="manager_dashboard.html" class="btn-back">ğŸ”™ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>  
</div>  

<div class="container">  
    <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ÙŠÙ† Ø§Ù„Ø³ÙŠØ§Ø­ÙŠÙŠÙ†</h1>  

    <select id="roleSelect" class="role-select">  
        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ± Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ÙŠÙ† --</option>  
        <option value="GUIDE">Ù…Ø±Ø´Ø¯ÙŠÙ†</option>  
        <option value="COMPANION">Ù…Ø±Ø§ÙÙ‚ÙŠÙ†</option>  
        <option value="DRIVER">Ø³Ø§Ø¦Ù‚ÙŠÙ†</option>  
    </select>  
    
    <input type="text" id="assistantSearch" class="filter-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø£Ùˆ Ø§Ù„ØªØ®ØµØµ..." onkeyup="window.filterAssistants()">

    <div id="assistantCardsGrid" class="cards-grid"></div>  
</div>  

<div id="commentsModal">  
    <div class="modal-content">  
        <span class="close-modal" onclick="window.closeCommentsModal()">âœ–</span>  
        <h2 style="color: var(--gold); border-bottom:1px solid #444; padding-bottom:10px;">ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯</h2>
        <div id="modalCommentsList"></div>  
    </div>  
</div>  

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getDatabase, ref, get, remove, onValue, off } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDpVqFWJfB4rA2-NA4QIl1w07e2LFQaYic",
  authDomain: "tourguideapp-313c1.firebaseapp.com",
  databaseURL: "https://tourguideapp-313c1-default-rtdb.firebaseio.com",
  projectId: "tourguideapp-313c1",
  storageBucket: "tourguideapp-313c1.appspot.com",
  messagingSenderId: "1036127588385",
  appId: "1:1036127588385:web:d144dba8f70fe094395360"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const roleSelect = document.getElementById('roleSelect');  
const modal = document.getElementById('commentsModal');  
const modalCommentsList = document.getElementById('modalCommentsList');  

const ROLES = { GUIDE:'assistants_guides', COMPANION:'assistants_companions', DRIVER:'assistants_drivers' };
let currentRoleKey = '';

// Ù‚Ø§Ø¦Ù…Ø© Ù„ØªØ®Ø²ÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ÙŠÙ† Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ù„ÙÙ„ØªØ±Ø©
let allAssistants = [];
// Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù€ Firebase Listeners Ù„ØºØ±Ø¶ Ø¥ÙŠÙ‚Ø§ÙÙ‡Ø§ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø¯ÙˆØ±
let activeListeners = [];

roleSelect.addEventListener('change', () => { 
    currentRoleKey = roleSelect.value;
    loadAndRenderAssistants(currentRoleKey); 
});  

function renderStars(rating){ return 'â­'.repeat(rating)+'â˜†'.repeat(5-rating); }

function getMajorityRating(comments){
    if(!comments || Object.keys(comments).length===0) return 5;
    const commentsArray = Array.isArray(comments) ? comments : Object.values(comments); 
    const counts = {};
    commentsArray.forEach(c=>counts[c.rating]=(counts[c.rating]||0)+1);
    let max=0, major=5;
    for(const r in counts){ if(counts[r]>max){ max=counts[r]; major=parseInt(r); } }
    return major;
}

// Ø¥ÙŠÙ‚Ø§Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ listeners Ø§Ù„Ù†Ø´Ø·Ø©
function stopListeners() {
    activeListeners.forEach(off);
    activeListeners = [];
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (ØªØ³ØªØ®Ø¯Ù… Ù„Ù„ÙÙ„ØªØ±Ø© ÙˆÙ„Ù„ØªØ­Ø¯ÙŠØ«)
function renderCards(assistantsList, roleKey) {
    stopListeners();
    const grid = document.getElementById('assistantCardsGrid');  
    grid.innerHTML = '';  
    if(assistantsList.length===0){ 
        grid.innerHTML='<p style="text-align:center;color:#aaa;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ø§Ø¹Ø¯ÙˆÙ† Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ± Ø£Ùˆ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«.</p>'; 
        return; 
    }

    assistantsList.forEach(a=>{
        const assistantId = a.appId;
        const card = document.createElement('div');
        card.className='assistant-card';
        card.setAttribute('data-name', a.name.toLowerCase());
        card.setAttribute('data-type', (a.guideType || a.specialization || a.role || '').toLowerCase());
        
        let details='';
        if(a.groupLimit){ details += `<p><strong>Ø§Ù„ØªØ®ØµØµ:</strong> ${a.guideType||''}</p><p><strong>Ø­Ø¯ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:</strong> ${a.groupLimit} Ø´Ø®Øµ</p><p><strong>Ø³Ø¹Ø± Ø§Ù„ÙŠÙˆÙ…:</strong> ${a.price} Ø¯Ø±Ù‡Ù…</p>`; }
        else if(a.specialization){ details += `<p><strong>Ø§Ù„ØªØ®ØµØµ:</strong> ${a.specialization||''}</p><p><strong>Ø³Ø¹Ø± Ø§Ù„ÙŠÙˆÙ…:</strong> ${a.priceDay} Ø¯Ø±Ù‡Ù…</p><p><strong>Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¹Ø©:</strong> ${a.priceHour} Ø¯Ø±Ù‡Ù…</p>`; }
        else if(a.cityPrice){ details += `<p><strong>Ø£Ø¬Ø±Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</strong> ${a.cityPrice} Ø¯Ø±Ù‡Ù…</p><p><strong>Ø£Ø¬Ø±Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</strong> ${a.outCityPrice} Ø¯Ø±Ù‡Ù…</p>`; }

        const initialRating = 5;

        card.innerHTML=`
            <div class="card-header">
                <img src="${a.img||'images/placeholder_profile.png'}" class="profile-img" alt="${a.name}">
                <div>
                    <h3>${a.name}</h3>
                    <div class="rating" id="rating-${assistantId}">${renderStars(initialRating)} (${a.experience} Ø³Ù†ÙˆØ§Øª)</div>
                </div>
            </div>
            <div class="card-details">${details}<p><strong>Ù†Ø¨Ø°Ø©:</strong> ${a.about}</p></div>
            <button class="btn-delete" onclick="window.deleteAssistant('${roleKey}','${assistantId}')">Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯</button>
            <button class="btn-comments" onclick="window.openCommentsModal('${assistantId}')">Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</button>
        `;
        grid.appendChild(card);

        const ratingElement = document.getElementById(`rating-${assistantId}`);
        const commentsRef = ref(db, `assistantComments/${assistantId}`);
        
        const listener = onValue(commentsRef, snap=>{
            const commentsData = snap.val() || {};
            const majorityRating = getMajorityRating(commentsData);
            ratingElement.innerHTML = `${renderStars(majorityRating)} (${a.experience} Ø³Ù†ÙˆØ§Øª)`;
        });
        activeListeners.push(listener);
    });
}

// Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ÙŠÙ† Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Firebase
async function loadAndRenderAssistants(roleKey) {
    const grid = document.getElementById('assistantCardsGrid');  

    if (!roleKey) {
        grid.innerHTML = '';
        return;
    }

    grid.innerHTML = '<p style="text-align:center;color:#ccc;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase...</p>';
    allAssistants = [];

    try {
        const snapshot = await get(ref(db, ROLES[roleKey]));
        const rawData = snapshot.val();
        const freshData = rawData ? Object.values(rawData) : [];

        allAssistants = freshData;
        renderCards(allAssistants, roleKey);
        
        if (allAssistants.length === 0) {
             grid.innerHTML = '<p style="text-align:center;color:#aaa;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ø§Ø¹Ø¯ÙˆÙ† Ù…Ø³Ø¬Ù„ÙˆÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ±.</p>';
        }

    } catch(error) {
        console.error("Error fetching data from Firebase:", error);
        grid.innerHTML = '<p style="text-align:center;color:var(--red-emergency);">ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯/Ø§Ù„Ù…Ø³Ø§Ø±).</p>';
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ù„ÙÙ„ØªØ±Ø© (Ø§Ù„Ø¨Ø­Ø«)
window.filterAssistants = function() {
    const searchTerm = document.getElementById('assistantSearch').value.toLowerCase();
    
    const filteredList = allAssistants.filter(a => {
        const nameMatch = a.name.toLowerCase().includes(searchTerm);
        const specializationMatch = (a.guideType || a.specialization || a.role || '').toLowerCase().includes(searchTerm);
        return nameMatch || specializationMatch;
    });
    renderCards(filteredList, currentRoleKey);
}


// ØªØ¹Ø±ÙŠÙ Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…ÙØ­Ø³Ù‘Ù†Ø©
window.deleteAssistant = async function(roleKey, appId){ 
    if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ ÙˆØªØ¹Ù„ÙŠÙ‚Ø§ØªÙ‡.')) return;
    
    const assistantPath = `${ROLES[roleKey]}/${appId}`;
    const commentsPath = `assistantComments/${appId}`;

    try {
        // 1. Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ù…Ù† Ù…Ø³Ø§Ø± Ø¯ÙˆØ±Ù‡ (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… appId)
        await remove(ref(db, assistantPath));

        // 2. Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯
        await remove(ref(db, commentsPath));
        
        alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ ÙˆØªØ¹Ù„ÙŠÙ‚Ø§ØªÙ‡ Ø¨Ù†Ø¬Ø§Ø­.");
        
        // 3. Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        loadAndRenderAssistants(roleKey); 
    } catch(error) {
        console.error("Error deleting assistant:", error);
        
        // ØªÙˆÙÙŠØ± Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ ØªÙˆØ¶Ø­ Ø³Ø¨Ø¨ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…Ø­ØªÙ…Ù„
        let errorMessage = "ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ù…Ø§Ù† (Firebase Rules) Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø­Ø°Ù ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø±:\n" + assistantPath;
        if (error.message.includes("permission_denied")) {
             errorMessage += "\n\nØ§Ù„Ø®Ø·Ø£ ÙŠØ´ÙŠØ± Ø¥Ù„Ù‰ Ø±ÙØ¶ Ø§Ù„Ø¥Ø°Ù† (Permission Denied). ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ù‚ÙˆØ§Ø¹Ø¯ Firebase.";
        } else {
             errorMessage = "ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: " + error.message;
        }

        alert(errorMessage);
    }
}

// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù… (Window)
window.openCommentsModal = function(appId){ 
    modalCommentsList.innerHTML='<p style="text-align:center;color:#ccc;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>';
    modal.style.display='flex';

    get(ref(db, `assistantComments/${appId}`)).then(snapshot => {
        modalCommentsList.innerHTML='';
        const comments = snapshot.val() || {};
        const commentKeys = Object.keys(comments);
        
        if(commentKeys.length===0){ 
            modalCommentsList.innerHTML='<p style="color:#aaa;text-align:center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</p>'; 
        } else {
            commentKeys.forEach((key) => {
                const c = comments[key];
                const div=document.createElement('div');
                div.className='comment-item';
                
                div.innerHTML=`<span class="comment-info"><span class="comment-name">${c.name||'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</span><span class="comment-stars">${renderStars(c.rating)}</span><span class="comment-text">${c.text}</span></span>`;
                
                const delBtn=document.createElement('button');
                delBtn.textContent="ğŸ—‘ï¸"; delBtn.style.cssText="background:var(--red-emergency);border:none;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer;";
                
                delBtn.onclick=async()=>{ 
                    if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ØŸ')){ 
                        try {
                            await remove(ref(db, `assistantComments/${appId}/${key}`)); 
                            window.openCommentsModal(appId); 
                        } catch(error) {
                            alert("ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚: " + error.message);
                        }
                    } 
                };
                div.appendChild(delBtn);
                modalCommentsList.appendChild(div);
            });
        }
    }).catch(error => {
        console.error("Error fetching comments:", error);
        modalCommentsList.innerHTML='<p style="color:var(--red-emergency);text-align:center;">ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª.</p>';
    });
}

// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù… (Window)
window.closeCommentsModal = function(){ 
    modal.style.display='none'; 
}

</script>
</body>  
</html>
